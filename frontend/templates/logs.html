{% extends "base.html" %}

{% block title %}System Logs{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="p-8 rounded-2xl shadow-glass transition-all duration-300" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3);">
        <div class="text-center">
            <h1 class="text-4xl font-extrabold text-text-primary mb-2">
                <i class="fas fa-clipboard-list mr-4 text-vista-blue"></i>
                System Logs
            </h1>
            <p class="text-lg font-medium text-text-secondary">Real-time monitoring and analysis of ETL operations</p>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Panel -->
        <div class="lg:col-span-2 p-6 rounded-2xl shadow-glass" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3);">
            <!-- Controls -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-3">
                    <select id="logLevel" class="px-4 py-2 rounded-xl border border-gray-200 bg-white text-text-primary focus:outline-none focus:ring-2 focus:ring-vista-blue">
                        <option value="all">All Levels</option>
                        <option value="info">Info</option>
                        <option value="warning">Warning</option>
                        <option value="error">Error</option>
                    </select>
                    <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-white border border-gray-200">
                        <input type="checkbox" id="autoRefresh" checked class="w-4 h-4 accent-vista-blue">
                        <label for="autoRefresh" class="text-sm font-medium text-text-secondary cursor-pointer">Auto-refresh</label>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="refreshBtn" class="glass-btn"><i class="fas fa-sync-alt mr-2"></i>Refresh</button>
                    <button id="clearBtn" class="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold"><i class="fas fa-trash mr-2"></i>Clear</button>
                </div>
            </div>
            <!-- Logs Display -->
            <div id="logsPanel" class="rounded-xl p-4 max-h-96 overflow-y-auto" style="background: rgba(17, 24, 39, 0.95); scrollbar-width: thin;">
                <div class="flex items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-10 w-10 border-4 border-azure border-t-vista-blue mr-4"></div>
                    <span class="text-lg text-gray-300">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Stats -->
            <div class="p-6 rounded-2xl shadow-glass" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h3 class="text-xl font-bold text-text-primary mb-4 flex items-center"><i class="fas fa-chart-bar mr-3 text-vista-blue"></i>Log Statistics</h3>
                <div class="space-y-3">
                    <div class="flex justify-between py-2 border-b"><span class="text-sm font-medium text-text-secondary">TOTAL LOGS</span><span id="totalLogs" class="text-lg font-bold">0</span></div>
                    <div class="flex justify-between py-2 border-b"><span class="text-sm font-medium text-text-secondary">ERRORS</span><span id="errorCount" class="text-lg font-bold text-red-600">0</span></div>
                    <div class="flex justify-between py-2 border-b"><span class="text-sm font-medium text-text-secondary">WARNINGS</span><span id="warningCount" class="text-lg font-bold text-amber-600">0</span></div>
                    <div class="flex justify-between py-2 border-b"><span class="text-sm font-medium text-text-secondary">INFO MESSAGES</span><span id="infoCount" class="text-lg font-bold text-green-600">0</span></div>
                    <div class="flex justify-between py-2"><span class="text-sm font-medium text-text-secondary">LAST UPDATE</span><span id="lastUpdate" class="text-sm font-bold">9:38:12 AM</span></div>
                </div>
            </div>

            <!-- Connection -->
            <div class="p-6 rounded-2xl shadow-glass" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3);">
                <h3 class="text-xl font-bold text-text-primary mb-4 flex items-center"><i class="fas fa-wifi mr-3 text-vista-blue"></i>Connection</h3>
                <div id="connectionStatus" class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-sm font-medium text-green-700">Connected</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.log-entry{margin-bottom:.75rem;padding:.75rem;border-radius:.5rem;border-left:3px solid transparent;background:rgba(31,41,55,.6);transition:all .3s}
.log-entry:hover{background:rgba(31,41,55,.8);transform:translateX(4px)}
.log-entry.info{border-left-color:#3b82f6;background:rgba(59,130,246,.1)}
.log-entry.warning{border-left-color:#f59e0b;background:rgba(245,158,11,.1)}
.log-entry.error{border-left-color:#ef4444;background:rgba(239,68,68,.1)}
.log-level{display:inline-flex;padding:.25rem .5rem;border-radius:.375rem;font-size:.75rem;font-weight:700;min-width:60px;text-transform:uppercase}
.log-level.info{background:rgba(59,130,246,.2);color:#60a5fa}
.log-level.warning{background:rgba(245,158,11,.2);color:#fbbf24}
.log-level.error{background:rgba(239,68,68,.2);color:#f87171}
.log-timestamp{color:#9ca3af;font-size:.75rem}
.log-message{color:#e5e7eb;word-wrap:break-word}
</style>

<script>
class LogsManager {
    constructor() {
        this.logs = [];
        this.filteredLogs = [];
        this.autoRefreshInterval = null;
        this.init();
    }

    init() {
        this.fetchLogs();
        document.getElementById('refreshBtn').addEventListener('click', () => this.fetchLogs());
        document.getElementById('clearBtn').addEventListener('click', () => this.clearLogs());
        document.getElementById('logLevel').addEventListener('change', () => this.applyFilters());
        document.getElementById('autoRefresh').addEventListener('change', (e) => this.toggleAutoRefresh(e.target.checked));
        this.toggleAutoRefresh(true);
    }

    toggleAutoRefresh(enabled) {
        if (enabled && !this.autoRefreshInterval) {
            this.autoRefreshInterval = setInterval(() => this.fetchLogs(), 3000);
        } else if (!enabled && this.autoRefreshInterval) {
            clearInterval(this.autoRefreshInterval);
            this.autoRefreshInterval = null;
        }
    }

    async fetchLogs() {
        try {
            console.log('[Logs] üì° Fetching logs from /api/logs/recent...');
            const response = await fetch('/api/logs/recent');
            
            console.log('[Logs] üì• Response status:', response.status);
            console.log('[Logs] üì• Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('[Logs] üì¶ Received data:', data);
            console.log('[Logs] üì¶ Data type:', typeof data);
            console.log('[Logs] üì¶ Has logs property:', 'logs' in data);
            console.log('[Logs] üì¶ Logs array length:', data.logs ? data.logs.length : 'N/A');
            
            if (data.file_path) {
                console.log('[Logs] üìÅ Log file path:', data.file_path);
            }
            if (data.message) {
                console.log('[Logs] üí¨ Server message:', data.message);
            }
            
            if (data.error) {
                console.error('[Logs] ‚ùå API returned error:', data.error);
                this.updateConnectionStatus(false, data.error);
                const panel = document.getElementById('logsPanel');
                panel.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <i class="fas fa-exclamation-triangle text-4xl text-yellow-400 mb-3"></i>
                        <p class="text-gray-300 font-medium mb-2">Unable to load logs</p>
                        <p class="text-gray-400 text-sm">${data.error}</p>
                    </div>
                `;
                return;
            }
            
            this.logs = data.logs || [];
            console.log(`[Logs] ‚úÖ Loaded ${this.logs.length} logs`);
            
            // Show first log for debugging
            if (this.logs.length > 0) {
                console.log('[Logs] üìã First log sample:', this.logs[0]);
            } else if (data.message) {
                // Show helpful message about empty log file
                const panel = document.getElementById('logsPanel');
                panel.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <i class="fas fa-info-circle text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500 font-medium">Log file is empty</p>
                        <p class="text-gray-400 text-sm mt-2">Run an ETL transformation to generate logs</p>
                        <p class="text-gray-500 text-xs mt-2 font-mono">${data.file_path || 'logs/etl.log'}</p>
                    </div>
                `;
                this.updateConnectionStatus(true);
                this.updateStats();
                return;
            }
            
            this.applyFilters();
            this.updateStats();
            this.updateConnectionStatus(true);
            
        } catch (error) {
            console.error('[Logs] ‚ùå Fetch error:', error);
            console.error('[Logs] ‚ùå Error stack:', error.stack);
            this.updateConnectionStatus(false, error.message);
        }
    }

    clearLogs() {
        this.logs = [];
        this.filteredLogs = [];
        this.renderLogs();
        this.updateStats();
    }

    updateConnectionStatus(connected, errorMsg = '') {
        const el = document.getElementById('connectionStatus');
        if (connected) {
            el.innerHTML = '<div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div><span class="text-sm font-medium text-green-700">Connected</span>';
        } else {
            el.innerHTML = `<div class="w-3 h-3 bg-red-500 rounded-full"></div><span class="text-sm font-medium text-red-700">Disconnected</span>`;
            if (errorMsg) {
                console.error('[Logs] Connection error:', errorMsg);
            }
        }
    }

    applyFilters() {
        const levelFilter = document.getElementById('logLevel').value;
        this.filteredLogs = this.logs.filter(log => {
            if (levelFilter !== 'all' && log.level && log.level.toLowerCase() !== levelFilter.toLowerCase()) {
                return false;
            }
            return true;
        });
        this.renderLogs();
    }

    renderLogs() {
        const panel = document.getElementById('logsPanel');
        
        console.log('[Logs] üé® Rendering logs...');
        console.log('[Logs] üé® Panel element:', panel);
        console.log('[Logs] üé® Filtered logs count:', this.filteredLogs.length);
        
        if (this.filteredLogs.length === 0) {
            console.log('[Logs] üé® No logs to display, showing empty state');
            panel.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <i class="fas fa-info-circle text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-500 font-medium">No logs available</p>
                    <p class="text-gray-400 text-sm mt-2">Logs will appear here once ETL operations are performed</p>
                </div>
            `;
            return;
        }

        console.log('[Logs] üé® Building HTML for', this.filteredLogs.length, 'logs');
        const html = this.filteredLogs.map((log, index) => {
            const level = (log.level || 'INFO').toLowerCase();
            const time = this.formatTime(log.timestamp);
            const msg = log.message || 'No message';
            
            if (index < 3) {
                console.log(`[Logs] üé® Log #${index}:`, {level, time, msg: msg.substring(0, 50)});
            }
            
            return `
                <div class="log-entry ${level}">
                    <div class="flex gap-3 mb-2">
                        <span class="log-level ${level}">${level.toUpperCase()}</span>
                        <span class="log-timestamp">${time}</span>
                    </div>
                    <div class="log-message">${this.escape(msg)}</div>
                </div>
            `;
        }).join('');
        
        console.log('[Logs] üé® HTML length:', html.length, 'characters');
        panel.innerHTML = html;
        panel.scrollTop = panel.scrollHeight;
        console.log('[Logs] ‚úÖ Rendering complete');
    }

    updateStats() {
        const total = this.logs.length;
        const errors = this.logs.filter(l => (l.level || '').toUpperCase() === 'ERROR').length;
        const warnings = this.logs.filter(l => (l.level || '').toUpperCase() === 'WARNING').length;
        const infos = this.logs.filter(l => (l.level || '').toUpperCase() === 'INFO').length;
        
        document.getElementById('totalLogs').textContent = total;
        document.getElementById('errorCount').textContent = errors;
        document.getElementById('warningCount').textContent = warnings;
        document.getElementById('infoCount').textContent = infos;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }

    formatTime(ts) {
        if (!ts) return 'N/A';
        try {
            return new Date(ts).toLocaleTimeString();
        } catch (e) {
            return ts;
        }
    }

    escape(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('[Logs] Initializing LogsManager...');
    window.logsManager = new LogsManager();
});
</script>
{% endblock %}
