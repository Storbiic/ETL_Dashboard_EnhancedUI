{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
    <!-- Header with Glassmorphism -->
    <div class="p-8 rounded-2xl shadow-glass transition-all duration-300 hover:shadow-glass-lg hover:-translate-y-1" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3);">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-extrabold text-text-primary mb-2">
                    <i class="fas fa-check-circle mr-4 text-vista-blue"></i>
                    ETL Results
                </h1>
                <p class="text-lg font-medium text-text-secondary">Download processed data and review transformation summary</p>
            </div>
            <a href="{{ url_for('index') }}" class="glass-btn">
                <i class="fas fa-plus mr-2"></i>New Transform
            </a>
        </div>
    </div>

    <!-- Success Message with Enhanced Styling -->
    <div class="p-6 rounded-2xl shadow-glass" style="background: linear-gradient(135deg, rgba(127, 158, 195, 0.15) 0%, rgba(93, 155, 173, 0.15) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(127, 158, 195, 0.3);">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-check-circle text-vista-blue text-3xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-xl font-bold text-vista-blue-dark">ETL Transformation Completed</h3>
                <div class="mt-2 text-lg font-semibold text-text-secondary">
                    Your Excel workbook has been successfully processed and transformed into Power BI-ready formats.
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics with Glassmorphism -->
    <div id="summary-section" class="p-6 rounded-2xl shadow-glass transition-all duration-300 hover:shadow-glass-lg hover:-translate-y-1" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3);">
        <h2 class="text-2xl font-bold text-text-primary mb-6 flex items-center">
            <i class="fas fa-chart-bar mr-3 text-vista-blue"></i>
            Transformation Summary
        </h2>
        <div id="summary-content">
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-10 w-10 border-4 border-azure border-t-vista-blue mr-4"></div>
                <span class="text-lg font-medium text-text-secondary">Loading summary...</span>
            </div>
        </div>
    </div>



    <!-- Download Artifacts with Enhanced Glassmorphism -->
    <div class="p-6 rounded-2xl shadow-glass transition-all duration-300 hover:shadow-glass-lg hover:-translate-y-1" style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3);">
        <h2 class="text-2xl font-bold text-text-primary mb-6 flex items-center">
            <i class="fas fa-download mr-3 text-vista-blue"></i>
            Download Files
        </h2>

        <!-- Organized Download Options with Enhanced Cards -->
        <div class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Power BI Optimized (Parquet) -->
            <div class="p-6 rounded-xl shadow-glass transition-all duration-300 hover:shadow-glass-lg hover:-translate-y-1" style="background: linear-gradient(135deg, rgba(127, 158, 195, 0.25) 0%, rgba(127, 158, 195, 0.1) 100%); backdrop-filter: blur(15px); border: 1px solid rgba(127, 158, 195, 0.5);">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-chart-bar text-2xl mt-1" style="color: #7f9ec3;"></i>
                    </div>
                    <div class="ml-4">
                        <h4 class="text-lg font-bold mb-3" style="color: #060505;">Power BI Package</h4>
                        <p class="text-sm font-medium text-text-secondary mb-4">
                            Optimized Parquet files in organized DATA_BI/ folder for direct Power BI import.
                        </p>
                        <button id="download-powerbi-btn" class="w-full text-white px-4 py-3 rounded-xl transition-all duration-300 text-sm font-semibold hover:scale-105" style="background: linear-gradient(135deg, #7f9ec3 0%, #5d7ea3 100%); box-shadow: 0 4px 14px 0 rgba(127, 158, 195, 0.5);">
                            <i class="fas fa-download mr-2"></i>
                            Download DATA_BI.zip
                        </button>
                        <div class="mt-3 text-xs font-medium space-y-1" style="color: #7f9ec3;">
                            <div><i class="fas fa-check mr-2"></i> Parquet format</div>
                            <div><i class="fas fa-check mr-2"></i> Optimized for Power BI</div>
                            <div><i class="fas fa-check mr-2"></i> Includes DAX measures</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSV Package -->
            <div class="p-6 rounded-xl shadow-glass transition-all duration-300 hover:shadow-glass-lg hover:-translate-y-1" style="background: linear-gradient(135deg, rgba(211, 228, 233, 0.7) 0%, rgba(211, 228, 233, 0.4) 100%); backdrop-filter: blur(15px); border: 1px solid rgba(211, 228, 233, 0.9);">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-file-csv text-2xl mt-1" style="color: #7f9ec3;"></i>
                    </div>
                    <div class="ml-4">
                        <h4 class="text-lg font-bold mb-3" style="color: #060505;">CSV Package</h4>
                        <p class="text-sm font-medium text-text-secondary mb-4">
                            CSV files in organized DATA_CSV/ folder for universal compatibility.
                        </p>
                        <button id="download-csv-btn" class="w-full text-white px-4 py-3 rounded-xl transition-all duration-300 text-sm font-semibold hover:scale-105" style="background: linear-gradient(135deg, #7f9ec3 0%, #5d7ea3 100%); box-shadow: 0 4px 14px 0 rgba(127, 158, 195, 0.5);">
                            <i class="fas fa-download mr-2"></i>
                            Download DATA_CSV.zip
                        </button>
                        <div class="mt-3 text-xs font-medium space-y-1" style="color: #7f9ec3;">
                            <div><i class="fas fa-check mr-2"></i> CSV format</div>
                            <div><i class="fas fa-check mr-2"></i> Universal compatibility</div>
                            <br>
                                                        <div><i class="fas fa-check mr-2"></i> Excel compatible</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SQLite Database -->
            <div class="p-6 rounded-xl shadow-glass transition-all duration-300 hover:shadow-glass-lg hover:-translate-y-1" style="background: linear-gradient(135deg, rgba(216, 36, 35, 0.12) 0%, rgba(216, 36, 35, 0.05) 100%); backdrop-filter: blur(15px); border: 1px solid rgba(216, 36, 35, 0.3);">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-database text-2xl mt-1" style="color: #d82423;"></i>
                    </div>
                    <div class="ml-4">
                        <h4 class="text-lg font-bold mb-3" style="color: #060505;">SQLite Database</h4>
                        <p class="text-sm font-medium text-text-secondary mb-4">
                            Single SQLite file containing all tables with proper relationships.
                        </p>
                        <button id="download-sqlite-btn" class="w-full text-white px-4 py-3 rounded-xl transition-all duration-300 text-sm font-semibold hover:scale-105" style="background: linear-gradient(135deg, #d82423 0%, #a81c1b 100%); box-shadow: 0 4px 14px 0 rgba(216, 36, 35, 0.4);">
                            <i class="fas fa-download mr-2"></i>
                            Download etl.sqlite
                        </button>
                        <div class="mt-3 text-xs font-medium space-y-1" style="color: #d82423;">
                            <div><i class="fas fa-check mr-2"></i> SQLite format</div>
                            <div><i class="fas fa-check mr-2"></i> Relational structure</div>
                            <div><i class="fas fa-check mr-2"></i> All tables included</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Individual Files with Scrollable Container -->
        <div class="mb-6">
            <h3 class="text-xl font-bold text-text-primary mb-4 flex items-center">
                <i class="fas fa-file-alt mr-3 text-vista-blue"></i>
                Individual Files
            </h3>
            <div class="max-h-80 overflow-y-auto pr-2" style="scrollbar-width: thin; scrollbar-color: rgba(147, 197, 253, 0.5) transparent;">
                <div id="file-list" class="space-y-3">
                    <div class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-10 w-10 border-4 border-azure border-t-vista-blue mr-4"></div>
                        <span class="text-lg font-medium text-text-secondary">Loading files...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Resources with Enhanced Styling -->
        <div class="border-t border-gray-200 pt-6">
            <h3 class="text-xl font-bold text-text-primary mb-4 flex items-center">
                <i class="fas fa-tools mr-3 text-vista-blue"></i>
                Additional Resources
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Data Dictionary -->
                <div class="p-4 rounded-xl shadow-glass transition-all duration-300 hover:shadow-glass-lg hover:-translate-y-1" style="background: linear-gradient(135deg, rgba(211, 228, 233, 0.5) 0%, rgba(211, 228, 233, 0.25) 100%); backdrop-filter: blur(15px); border: 1px solid rgba(211, 228, 233, 0.7);">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-book text-xl mr-3" style="color: #7f9ec3;"></i>
                            <div>
                                <h4 class="font-semibold" style="color: #060505;">Data Dictionary</h4>
                                <p class="text-sm font-medium text-text-secondary">Column mappings and descriptions</p>
                            </div>
                        </div>
                        <button id="download-dictionary-btn" class="text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium hover:scale-105" style="background: linear-gradient(135deg, #7f9ec3 0%, #5d7ea3 100%); box-shadow: 0 4px 14px 0 rgba(127, 158, 195, 0.5);">
                            <i class="fas fa-download mr-1"></i>Download
                        </button>
                    </div>
                </div>

                <!-- Power Query Scripts -->
                <div class="p-4 rounded-xl shadow-glass transition-all duration-300 hover:shadow-glass-lg hover:-translate-y-1" style="background: linear-gradient(135deg, rgba(127, 158, 195, 0.2) 0%, rgba(127, 158, 195, 0.1) 100%); backdrop-filter: blur(15px); border: 1px solid rgba(127, 158, 195, 0.4);">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-code text-xl mr-3" style="color: #7f9ec3;"></i>
                            <div>
                                <h4 class="font-semibold" style="color: #060505;">Power Query Scripts</h4>
                                <p class="text-sm font-medium text-text-secondary">M-code for Power BI connections</p>
                            </div>
                        </div>
                        <button id="download-powerquery-btn" class="text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium hover:scale-105" style="background: linear-gradient(135deg, #7f9ec3 0%, #5d7ea3 100%); box-shadow: 0 4px 14px 0 rgba(127, 158, 195, 0.5);">
                            <i class="fas fa-download mr-1"></i>Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Progress tracker update
document.addEventListener('DOMContentLoaded', function() {
    // Update progress tracker to show Downloads step at 100%
    if (window.GlobalProgressTracker) {
        console.log('[Results Page] Setting progress to step 4 (Downloads) at 100%');
        window.GlobalProgressTracker.updateStep(3, 'completed', 100);
        window.GlobalProgressTracker.updateStep(4, 'current', 100);
    }

    // Hide the loading spinners and show static content
    const summaryContent = document.getElementById('summary-content');
    if (summaryContent) {
        summaryContent.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 rounded-xl shadow-glass" style="background: linear-gradient(135deg, rgba(127, 158, 195, 0.2) 0%, rgba(127, 158, 195, 0.1) 100%); backdrop-filter: blur(15px); border: 1px solid rgba(127, 158, 195, 0.4);">
                    <div class="flex items-center">
                        <i class="fas fa-table text-2xl mr-3" style="color: #7f9ec3;"></i>
                        <div>
                            <h4 class="font-semibold" style="color: #060505;">Tables Created</h4>
                            <p class="text-2xl font-bold" style="color: #7f9ec3;">5</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 rounded-xl shadow-glass" style="background: linear-gradient(135deg, rgba(211, 228, 233, 0.6) 0%, rgba(211, 228, 233, 0.3) 100%); backdrop-filter: blur(15px); border: 1px solid rgba(211, 228, 233, 0.8);">
                    <div class="flex items-center">
                        <i class="fas fa-list text-2xl mr-3" style="color: #7f9ec3;"></i>
                        <div>
                            <h4 class="font-semibold" style="color: #060505;">Files Generated</h4>
                            <p class="text-2xl font-bold" style="color: #7f9ec3;">15+</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 rounded-xl shadow-glass" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%); backdrop-filter: blur(15px); border: 1px solid rgba(16, 185, 129, 0.3);">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-2xl mr-3" style="color: #10b981;"></i>
                        <div>
                            <h4 class="font-semibold" style="color: #060505;">Status</h4>
                            <p class="text-2xl font-bold" style="color: #10b981;">Success</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Show individual files list
    const fileList = document.getElementById('file-list');
    if (fileList) {
        const commonFiles = [
            { name: 'masterbom_clean.csv', icon: 'fa-file-csv' },
            { name: 'masterbom_clean.parquet', icon: 'fa-database' },
            { name: 'fact_parts.csv', icon: 'fa-file-csv' },
            { name: 'fact_parts.parquet', icon: 'fa-database' },
            { name: 'dim_dates.csv', icon: 'fa-file-csv' },
            { name: 'dim_dates.parquet', icon: 'fa-database' },
            { name: 'plant_item_status.csv', icon: 'fa-file-csv' },
            { name: 'plant_item_status.parquet', icon: 'fa-database' },
            { name: 'etl.sqlite', icon: 'fa-database' },
            { name: 'data_dictionary.md', icon: 'fa-file-alt' }
        ];

        fileList.innerHTML = commonFiles.map(file => `
            <div class="p-4 rounded-xl shadow-glass transition-all duration-300 hover:shadow-glass-lg hover:-translate-y-1" style="background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 100%); backdrop-filter: blur(15px); border: 1px solid rgba(211, 228, 233, 0.5);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1">
                        <i class="fas ${file.icon} text-2xl mr-4" style="color: #7f9ec3;"></i>
                        <div class="flex-1">
                            <h4 class="font-semibold" style="color: #060505;">${file.name}</h4>
                            <div class="text-sm text-text-secondary mt-1">
                                <span>Ready for download</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="downloadFile('${file.name}')" 
                            class="text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium hover:scale-105" style="background: linear-gradient(135deg, #7f9ec3 0%, #5d7ea3 100%); box-shadow: 0 4px 14px 0 rgba(127, 158, 195, 0.5);">
                        <i class="fas fa-download mr-2"></i>Download
                    </button>
                </div>
            </div>
        `).join('');
    }
});

function downloadFile(filename) {
    const link = document.createElement('a');
    link.href = `/download/${encodeURIComponent(filename)}`;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Download button handlers for bulk downloads
document.getElementById('download-powerbi-btn')?.addEventListener('click', function() {
    downloadFile('DATA_BI.zip');
});

document.getElementById('download-csv-btn')?.addEventListener('click', function() {
    downloadFile('DATA_CSV.zip');
});

document.getElementById('download-sqlite-btn')?.addEventListener('click', function() {
    downloadFile('etl.sqlite');
});

document.getElementById('download-dictionary-btn')?.addEventListener('click', function() {
    downloadFile('data_dictionary.md');
});

document.getElementById('download-powerquery-btn')?.addEventListener('click', function() {
    downloadFile('power_query_connectors.md');
});
</script>

{% endblock %}
